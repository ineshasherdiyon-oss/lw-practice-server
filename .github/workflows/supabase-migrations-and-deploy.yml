name: Run Supabase migrations and trigger Render deploy

# run on push to main (adjust branch if needed)
on:
  push:
    branches:
      - main

jobs:
  migrate:
    name: Apply Supabase migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Node (for supabase CLI)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Supabase CLI
        run: npm install -g supabase@latest

      - name: Run Supabase migrations (push DB changes)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Ensure we have a project ref to target
          if [ -z "${{ secrets.SUPABASE_PROJECT_REF }}" ]; then
            echo "Missing SUPABASE_PROJECT_REF (set this repo secret)."
            exit 1
          fi

          # If you keep a local supabase/config, the CLI will pick it up.
          # Use `db push` to apply local migrations to the remote project.
          supabase db push --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}"

  trigger_render_deploy:
    name: Trigger Render deploy (optional)
    runs-on: ubuntu-latest
    needs: migrate
    if: ${{ secrets.RENDER_DEPLOY_HOOK != '' }} # only run if hook provided
    steps:
      - name: Trigger Render via Deploy Hook
        env:
          RENDER_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "Calling Render deploy hook..."
          curl -sS -X POST "$RENDER_HOOK" --fail -o /dev/null
          echo "Render deploy triggered."
